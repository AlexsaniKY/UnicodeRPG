<!DOCTYPE html>
<html>
<head>
	<title>Page Title</title>
	<meta charset=utf-8>
	<style rel="stylesheet" type="text/css">
		.grid-con{
			font-family:monospace;
			font-size:16px;
			display:grid;
			grid-gap:0;
		}

		.grid-tile{
			
		}
		
		.spr-bg{
			width:100%;
			height:100%;
			display:flex;
			justify-content:center;
			align-items:center;
		}
		
		.spr-con{
			position:relative;
			top:-1em;
			left:-.5ch;
		}
		
		canvas{
			border: 1px solid black;
		}
	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>

	
	<div id="new-grid-div"></div>
	<div id="character" style="position:fixed; left:0.41em; top:0.5em;">@</div>
	<div>
		<canvas id="canvas_element" style= "width:100%; height:100%;"></canvas>
	</div>
	
<script>
	//grid base defines the grid's width and font size, parent to grid tiles
	let grid_base = document.createElement("div");
	grid_base.className = "grid-con";
	
	//grid tile defines each grid square, contains sprites
	let grid_tile_base = document.createElement("div");
	grid_tile_base.className = "grid-tile";
	
	let sprite_bg = document.createElement("div");
	sprite_bg.className = "spr-bg";
	
	//sprite contains character based sprite parts
	let sprite_base = document.createElement("div");
	sprite_base.className = "spr-con";
	
	//sprite part contains each character in a sprite
	let sprite_part_base = document.createElement("p");
	sprite_part_base.style.position = "absolute";
	

	//constructs a sprite node from sprite object definition
	function node_from_sprite(sprite_object){
		let sprite = sprite_bg.cloneNode();
		if(sprite_object.background) sprite.style.backgroundColor = sprite_object.background;
		
		let sprite_container = sprite_base.cloneNode();

		let sprite_part;
		for(s of sprite_object.chars){
			sprite_part = sprite_part_base.cloneNode();

			sprite_part.innerHTML = s.ch;
			sprite_part.style.color = s.color;
			sprite_part.style.top = s.offsetY + "em";
			sprite_part.style.left = s.offsetX + "ch";

			sprite_container.appendChild(sprite_part);
		}
		
		sprite.appendChild(sprite_container);
		
		return sprite;
	}
	
	//Constructs Grid.  Width and height should be defined in ch and em respectively
	function create_grid(x, y, width, height){
		let newgriddiv = grid_base.cloneNode();
		newgriddiv.style.gridTemplateColumns = "repeat(" + x + ", 1fr)";
		newgriddiv.style.height = height;
		newgriddiv.style.width = width;
		let clone;
		for(let row=0; row<y; row++){
			for(let col=0; col<x; col++){
				clone = grid_tile_base.cloneNode(true);
				clone.id = "" + row + "," + col;
				newgriddiv.appendChild(clone);
			}
		}
		return newgriddiv;
	}
	
	//constructs html node from map defining tiles,
	//tileset mapping tile id -> sprite name
	//sprite name references the sprite in "sprites"
	function mapnode_from_array(array, tileset, sprites){
		let sprite_nodes = {};
		for(s of sprites) sprite_nodes[s.name] = node_from_sprite(s);
	
		let x = array[0].length;
		let y = array.length;
		let grid = create_grid(
									x, 
									y, 
									x*.8 + "em", 
									y*1.2 + "em"
									);
		let node;
		for(let j = 0; j < y; j++){
			for(let i = 0; i < x; i++){
				node = grid.childNodes[j*x + i];
				//map position -> tile id
				//tile id -> sprite name in tileset
				//sprite name -> sprite node
				//clone sprite node and append
				node.appendChild( 
					sprite_nodes[ 
						tileset[ 
							array[j][i]
							] 
						].cloneNode(true) 
					);
			}
		} 
		return grid;
	}
	
	window.addEventListener("keydown", (event) => {
		//console.log("" + event.key + " " + event.keyIdentifier + " " + event.keyCode);
		//event.key will respect shift, the keycode shows code from capital letter
		let player = document.getElementById("character");
		let x = parseFloat(player.style.left);
		let y = parseFloat(player.style.top);
		console.log(event.keyCode);
		let dx=0,dy=0;
		switch(event.keyCode){
			case 68://D
				dx += .5;
				break;
			case 83://S
				dy += .5;
				break;
			case 65://A
				dx -= .5;
				break;
			case 87://W
				dy -= .5;
				break;
		}
		
		player.style.left = dx*0.8 + x + "em";
		player.style.top  = dy*1.2 + y + "em";
		
	}, true);
	
	
	// sprites are defined as objects with:
	// name,
	// chars: [{ch , color, offsetX, offsetY}, ]
	// where each char is a unicode string (generally a single character)
	// that is assigned a color, and a set of offsets where:
	// positive x => right
	// positive y => down
	let sprites = [
		{
			name: "Grass",
			background:"aquamarine",
			chars:[{
					ch: "&#x22ce",
					color: "green",
					offsetX: .05,
					offsetY: -.6
					},
					{
					ch: "v",
					color: "green",
					offsetX:0.08,
					offsetY:-.45
					}
				]
		},
		
		{
			name: "Tree",
			background: "#94a893",
			chars:[{
					ch: "i",
					color: "brown",
					offsetX: 0,
					offsetY: -.3
					},
					{
					ch: "&#x13dc",
					color: "green",
					offsetX: -.2,
					offsetY: -.8
					}
				]
		},
		
		{
			name: "Dirt",
			background: "antiquewhite",
			chars:[{
					ch: "&#x289e",
					color: "sandybrown",
					offsetX: .0,
					offsetY: -.8
					}
				]
		},
		
		{
			name: "Water",
			background: "#94a8d4",
			chars:[{
				ch: "&#x2248",
				color: "blue",
				offsetX: 0,
				offsetY: -.3
				},
				{
				ch: "&#x2248",
				color: "blue",
				offsetX: 0,
				offsetY: -.8
				}
			]
		}
		
	];
	
	
	let tileset = {
		0: "Grass",
		1: "Tree",
		2: "Dirt",
		3: "Water"
	};
	let map = [
		[1,1,1,1,1,1],
		[1,0,0,2,3,1],
		[1,0,2,2,3,1],
		[1,0,2,0,3,1],
		[1,1,2,1,3,1]
	];
	
	//add a constructed grid to document
	let newgrid = document.getElementById("new-grid-div");
	
	let gridx = 40, gridy = 16;
	let gridarray = new Array(gridy);
	for(let i=0; i<gridy; i++) gridarray[i] = new Array(gridx).fill(0);
	
	newgrid.appendChild(mapnode_from_array(gridarray, tileset, sprites));
	
	
	let canvas  = document.getElementById("canvas_element");
	let context = canvas.getContext("2d");
	let width = canvas.offsetWidth;
	let height = canvas.offsetHeight;
	
	let tile_canvas = document.createElement("canvas");
	tile_canvas.style.width = "32px";
	tile_canvas.style.height = "48px";
	let tile_context = tile_canvas.getContext("2d");
	
	//let image;
	function gameInit(){
		tile_context.fillStyle = "#00F";
		tile_context.fillRect(0,0,32,48);
		//image = tile_context.getImageData(0,0,32,48);
	}
	
	let maxfps = 20;
	let frame_length = 1000./ maxfps;
	let last_frame_stamp = 0;
	let frame_delta = frame_length;
	function gameLoop(timestamp){
		frame_delta = last_frame_stamp + frame_length;
		if(timestamp < frame_delta){
			//console.log(last_frame_stamp + frame_length - timestamp);
			requestAnimationFrame(gameLoop);
			return;
		}
		last_frame_stamp = timestamp;
		
		context.fillStyle = "#F00";
		context.fillRect(0,0,width,height);
		context.drawImage(tile_canvas, 0,0);
		context.fillStyle = "#000";
		context.fillRect(32,48,16,16);
		
		requestAnimationFrame(gameLoop);
	}
	
gameInit();
gameLoop(0);
		
</script>
</body>
</html>