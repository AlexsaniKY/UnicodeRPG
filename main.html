<!DOCTYPE html>
<html>
<head>
	<title>Page Title</title>
	<meta charset=utf-8>
	<style rel="stylesheet" type="text/css">
		.grid-con{
			font-family:monospace;
			font-size:16px;
			display:grid;
			grid-gap:0;
		}

		.grid-tile{
			display:flex;
			justify-content:center;
			align-items:center;
		}
		
		.spr-con{
			position:relative;
			top:-1em;
			left:-.5ch;
		}
	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>

	<div id="new-grid-div" class="grid-con"></div>

<script>
	//sprite base is used to clone character based sprites
	let sprite_base = document.createElement("div");
	sprite_base.className = "spr-con";
	//sprite part base is used to clone each character in a sprite
	let sprite_part_base = document.createElement("p");
	sprite_part_base.style.position = "absolute";
	
	// sprites are defined as objects with:
	// name,
	// chars: [{ch , color, offsetX, offsetY}, ]
	// where each char is a unicode string (generally a single character)
	// that is assigned a color, and a set of offsets where:
	// positive x => right
	// positive y => down
	let sprites = [
		{
			name: "Grass",
			chars:[{
					ch: "&#x22ce",
					color: "green",
					offsetX: .05,
					offsetY: -.6
					},
					{
					ch: "v",
					color: "green",
					offsetX:0.08,
					offsetY:-.45
					}
				]
		},
		{
			name: "Tree",
			chars:[{
					ch: "i",
					color: "brown",
					offsetX: 0,
					offsetY: -.3
					},
					{
					ch: "&#x13dc",
					color: "green",
					offsetX: -.2,
					offsetY: -.8
					}
				]
		},
		{
			name: "Dirt",
			chars:[{
					ch: "&#x289e",
					color: "sandybrown",
					offsetX: .0,
					offsetY: -.8
					}
				]
		},
		{
			name: "Water",
			background: "lightblue",//TODO: restructure sprites to allow background colors
			chars:[{
				ch: "&#x2248",
				color: "blue",
				offsetX: 0,
				offsetY: -.3
				},
				{
				ch: "&#x2248",
				color: "blue",
				offsetX: 0,
				offsetY: -.8
				}
			]
		}
	];
	
	
	let tileset = {
		0: "Grass",
		1: "Tree",
		2: "Dirt",
		3: "Water"
	};
	let map = [
		[1,1,1,1,1,1],
		[1,0,0,2,3,1],
		[1,0,2,2,3,1],
		[1,0,2,0,3,1],
		[1,1,2,1,3,1]
	];
	
	
	
	function node_from_sprite(sprite_object){
		let sprite = sprite_base.cloneNode();

		let sprite_part;
		for(s of sprite_object.chars){
			sprite_part = sprite_part_base.cloneNode();

			sprite_part.innerHTML = s.ch;
			sprite_part.style.color = s.color;
			sprite_part.style.top = s.offsetY + "em";
			sprite_part.style.left = s.offsetX + "ch";

			sprite.appendChild(sprite_part);
		}
		return sprite;
	}
	
	
	//programmatic grid definitions
	let grid_template = document.createElement("div");
	grid_template.className = "grid-con";
	
	let gridtile = document.createElement("div");
	gridtile.className = "grid-tile";
	
	function createGrid(x, y, width, height){
		let newgriddiv = grid_template.cloneNode();
		newgriddiv.style.gridTemplateColumns = "repeat(" + x + ", 1fr)";
		newgriddiv.style.height = height;
		newgriddiv.style.width = width;
		let clone;
		for(let row=0; row<y; row++){
			for(let col=0; col<x; col++){
				clone = gridtile.cloneNode(true);
				clone.id = "" + row + "," + col;
				newgriddiv.appendChild(clone);
			}
		}
		return newgriddiv;
	}
	

	function node_from_map(map, tileset, sprites){
		let sprite_nodes = {};
		for(s of sprites) sprite_nodes[s.name] = node_from_sprite(s);
	
		let x = map[0].length;
		let y = map.length;
		let grid = createGrid(x, y, x*1.5 + "ch", y*1.2 + "em");
		
		let node;
		for(let j = 0; j < y; j++){
			for(let i = 0; i < x; i++){
				node = grid.childNodes[j*x + i];
				node.appendChild( sprite_nodes[ tileset[ map[j][i]] ].cloneNode(true) );
			}
		} 
		return grid;
	}
	
	let body = document.getElementsByTagName("body")[0];
	body.appendChild(node_from_map(map, tileset, sprites));
		
		
		
	let grass_element = document.getElementById("3,3");
	while(grass_element.firstChild){
		grass_element.removeChild(grass_element.firstChild);
	}
	grass_element.appendChild(node_from_sprite(sprites[0]));
	
	let tree_element = document.getElementById("4,4");
	while(tree_element.firstChild){
		tree_element.removeChild(tree_element.firstChild);
	}
	tree_element.appendChild(node_from_sprite(sprites[1]));
		
</script>
</body>
</html>